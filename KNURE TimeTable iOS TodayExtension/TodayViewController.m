////
////  TodayViewController.m
////  KNURE TimeTable iOS TodayExtension
////
////  Created by Vladislav Chapaev on 09.11.16.
////  Copyright Â© 2016 Vladislav Chapaev. All rights reserved.
////
//
//#import "TodayViewController.h"
//#import "MSCollectionViewCalendarLayout.h"
//#import "LessonCollectionViewCell.h"
//#import "Lesson.h"
//#import "UIScrollView+EmptyDataSet.h"
//#import "EventParser.h"
//#import "Configuration.h"
//
//#import "MSGridline.h"
//#import "MSTimeRowHeaderBackground.h"
//#import "MSDayColumnHeaderBackground.h"
//#import "MSDayColumnHeader.h"
//#import "MSTimeRowHeader.h"
//#import "MSCurrentTimeIndicator.h"
//#import "MSCurrentTimeGridline.h"
//
//NSString *const MSEventCellReuseIdentifier = @"MSEventCellReuseIdentifier";
//NSString *const MSDayColumnHeaderReuseIdentifier = @"MSDayColumnHeaderReuseIdentifier";
//NSString *const MSTimeRowHeaderReuseIdentifier = @"MSTimeRowHeaderReuseIdentifier";
//
//CGFloat const timeRowHeaderWidth = 44;
//CGFloat const dayColumnHeaderHeight = 44;
//
//@interface TodayViewController () <NCWidgetProviding, MSCollectionViewDelegateCalendarLayout, NSFetchedResultsControllerDelegate, DZNEmptyDataSetSource>
//
//@property (strong, nonatomic) NSFetchedResultsController *fetchedResultsController;
//@property (strong, nonatomic) MSCollectionViewCalendarLayout *collectionViewCalendarLayout;
//
//@property (strong, nonatomic) NSDateFormatter *formatter;
//@property (strong, nonatomic) NSArray <NSDate *>* pairDates;
//@property (assign, nonatomic) short maxPairNumber;
//@property (assign, nonatomic) short minPairNumber;
//
//@property (strong, nonatomic) NSDictionary *selectedItem;
//@property (assign, nonatomic) BOOL isDarkTheme;
//
//@end
//
//@implementation TodayViewController
//
//- (instancetype)initWithCoder:(NSCoder *)aDecoder {
//    self = [super initWithCoder:aDecoder];
//    if (self) {
//        self.collectionViewCalendarLayout = [[MSCollectionViewCalendarLayout alloc] init];
//        self.collectionViewCalendarLayout.delegate = self;
//
//        [EventParser initializeSharedStorage];
//
//        self = [super initWithCollectionViewLayout:self.collectionViewCalendarLayout];
//    }
//    return self;
//}
//
//- (void)viewDidLoad {
//    [super viewDidLoad];
//    [self setupColorTheme];
//
//    NSUserDefaults *sharedDefaults = [[NSUserDefaults alloc] initWithSuiteName:@"group.Shogunate.KNURE-Sked"];
//    self.selectedItem = [sharedDefaults valueForKey:TimetableSelectedItem];
//    if (self.selectedItem) {
//        NSDateComponents *endDateComponents = [[NSDateComponents alloc]init];
//        NSCalendar *calendar = [NSCalendar calendarWithIdentifier:NSCalendarIdentifierGregorian];
//        NSDateComponents *startDateComponent = [calendar components:(NSCalendarUnitYear | NSCalendarUnitMonth | NSCalendarUnitDay) fromDate:[NSDate date]];
//        startDateComponent.timeZone = [NSTimeZone timeZoneWithName:@"Europe/Kiev"];
//
//        NSDate *startDate = [calendar dateFromComponents:startDateComponent];
//        endDateComponents.day = 1;
//        NSDate *endDate = [calendar dateByAddingComponents:endDateComponents toDate:startDate options:0];
//        NSPredicate *predicate = [NSPredicate predicateWithFormat:@"item_id == %@ AND ((start_time >= %@) AND (end_time <= %@)) AND isDummy == NO", self.selectedItem[@"id"], startDate, endDate];
//
//        [self setupFetchRequestWithPredicate:predicate];
//    }
//
//    [self setupProperties];
//    [self setupCollectionView];
//}
//
//- (void)viewDidAppear:(BOOL)animated {
//    [super viewDidAppear:animated];
//    if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 10.0) {
//        self.extensionContext.widgetLargestAvailableDisplayMode = NCWidgetDisplayModeExpanded;
//    }
//    self.preferredContentSize = (self.collectionView.contentSize.height > 0) ? self.collectionView.contentSize : CGSizeMake(320, 80);
//}
//
//#pragma mark - NCWidgetProviding
//
//- (UIEdgeInsets)widgetMarginInsetsForProposedMarginInsets:(UIEdgeInsets)defaultMarginInsets {
//    return UIEdgeInsetsZero;
//}
//
//- (void)widgetActiveDisplayModeDidChange:(NCWidgetDisplayMode)activeDisplayMode withMaximumSize:(CGSize)maxSize {
//    if (activeDisplayMode == NCWidgetDisplayModeExpanded) {
//        self.preferredContentSize = self.collectionView.contentSize;
//    } else if (activeDisplayMode == NCWidgetDisplayModeCompact) {
//        self.preferredContentSize = CGSizeMake(maxSize.width, 400);
//    }
//}
//
//#pragma mark - UIContentContainer
//
//- (void)viewWillTransitionToSize:(CGSize)size withTransitionCoordinator:(id<UIViewControllerTransitionCoordinator>)coordinator {
//    [self.collectionViewCalendarLayout invalidateLayoutCache];
//    self.collectionViewCalendarLayout.sectionWidth = size.width - timeRowHeaderWidth - 10;
//    [self.collectionView reloadData];
//}
//
//#pragma mark - Setup
//
//- (void)setupCollectionView {
//    self.collectionView.emptyDataSetSource = self;
//    self.collectionView.backgroundColor = [UIColor clearColor];
//    self.collectionView.showsVerticalScrollIndicator = NO;
//    self.collectionView.showsHorizontalScrollIndicator = NO;
//
//    [self.collectionView registerClass:LessonCollectionViewCell.class forCellWithReuseIdentifier:MSEventCellReuseIdentifier];
//    [self.collectionView registerClass:MSDayColumnHeader.class forSupplementaryViewOfKind:MSCollectionElementKindDayColumnHeader withReuseIdentifier:MSDayColumnHeaderReuseIdentifier];
//    [self.collectionView registerClass:MSTimeRowHeader.class forSupplementaryViewOfKind:MSCollectionElementKindTimeRowHeader withReuseIdentifier:MSTimeRowHeaderReuseIdentifier];
//
//    self.collectionViewCalendarLayout.timeRowHeaderWidth = timeRowHeaderWidth;
//    self.collectionViewCalendarLayout.dayColumnHeaderHeight = dayColumnHeaderHeight;
//
//    self.collectionViewCalendarLayout.sectionLayoutType = MSSectionLayoutTypeVerticalTile;
//    self.collectionViewCalendarLayout.sectionWidth = self.collectionView.frame.size.width;
//    self.collectionViewCalendarLayout.hourHeight = 30;
//
//    [self.collectionViewLayout registerClass:MSCurrentTimeGridline.class forDecorationViewOfKind:MSCollectionElementKindCurrentTimeHorizontalGridline];
//    [self.collectionViewLayout registerClass:MSGridline.class forDecorationViewOfKind:MSCollectionElementKindVerticalGridline];
//    [self.collectionViewLayout registerClass:MSTimeRowHeaderBackground.class forDecorationViewOfKind:MSCollectionElementKindTimeRowHeaderBackground];
//    [self.collectionViewLayout registerClass:MSDayColumnHeaderBackground.class forDecorationViewOfKind:MSCollectionElementKindDayColumnHeaderBackground];
//}
//
//- (void)setupProperties {
//    NSArray *pairNumbers = [self.fetchedResultsController.fetchedObjects valueForKey:@"number_pair"];
//    self.maxPairNumber = [[pairNumbers valueForKeyPath:@"@max.intValue"] shortValue];
//    self.minPairNumber = [[pairNumbers valueForKeyPath:@"@min.intValue"] shortValue] - 1;
//    if (self.minPairNumber < 0) { self.minPairNumber = 0; }
//
//    self.formatter = [[NSDateFormatter alloc]init];
//    [self.formatter setDateFormat:@"EEEE, dd MMMM"];
//
//    NSArray <NSDate *>*startTimeList = [self.fetchedResultsController.fetchedObjects valueForKey:@"start_time"];
//    NSArray <NSDate *>*endTimeList = [self.fetchedResultsController.fetchedObjects valueForKey:@"end_time"];
//    NSArray <NSDate *>*newArray = [startTimeList arrayByAddingObjectsFromArray:endTimeList];
//    NSMutableArray <NSDate *>*dates = [[NSMutableArray alloc]init];
//    for (NSDate *date in newArray) {
//        NSCalendar *calendar = [NSCalendar autoupdatingCurrentCalendar];
//        NSDateComponents *component = [calendar components:(NSCalendarUnitHour | NSCalendarUnitMinute) fromDate:date];
//        [dates addObject:[calendar dateFromComponents:component]];
//    }
//    self.pairDates = [[[NSOrderedSet orderedSetWithArray:dates] array] sortedArrayUsingSelector:@selector(compare:)];
//}
//
//- (void)setupFetchRequestWithPredicate:(NSPredicate *)predicate {
//    NSFetchRequest *fetchRequest = [Lesson fetchRequest];
//
//    fetchRequest.predicate = predicate;
//    fetchRequest.sortDescriptors = @[[NSSortDescriptor sortDescriptorWithKey:@"start_time" ascending:YES]];
//
//    self.fetchedResultsController = [[NSFetchedResultsController alloc] initWithFetchRequest:fetchRequest managedObjectContext:[NSManagedObjectContext MR_defaultContext] sectionNameKeyPath:@"day" cacheName:nil];
//    self.fetchedResultsController.delegate = self;
//
//    NSError *error = nil;
//    if (![self.fetchedResultsController performFetch:&error]) {
//        NSLog(@"Unresolved error %@, %@", error, [error userInfo]);
//        abort();
//    }
//}
//
//- (void)setupColorTheme {
//    [MSCurrentTimeGridline appearance].backgroundColor = ApplicationThemeLightCurrentTimeIndicator;
//    if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 10.0) {
//        self.isDarkTheme = NO;
//    } else {
//        self.isDarkTheme = YES;
//    }
//}
//
//#pragma mark - NSFetchedResultsControllerDelegate
//
//- (void)controllerDidChangeContent:(NSFetchedResultsController *)controller {
//    [self.collectionViewCalendarLayout invalidateLayoutCache];
//    [self.collectionView reloadData];
//}
//
//#pragma mark - UICollectionViewDataSource
//
//- (NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView {
//    return self.fetchedResultsController.sections.count;
//}
//
//- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
//    return [(id <NSFetchedResultsSectionInfo>)self.fetchedResultsController.sections[section] numberOfObjects];
//}
//
//- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath {
//    LessonCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:MSEventCellReuseIdentifier forIndexPath:indexPath];
//    Lesson *lesson = [self.fetchedResultsController objectAtIndexPath:indexPath];
//    cell.opacity = (self.isDarkTheme) ? 0.55 : 0.3;
//    cell.mainColor = [EventParser getCellColorByType:lesson.type.integerValue isDarkTheme:self.isDarkTheme];
//    cell.textColor = (self.isDarkTheme) ? ApplicationThemeDarkFontPrimaryColor : ApplicationThemeLightFontSecondnaryColor;
//    cell.textColorHighlighted = ApplicationThemeDarkFontPrimaryColor;
//    cell.title = lesson.brief;
//    cell.location = lesson.auditory;
//    return cell;
//}
//
//- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath {
//    if (kind == MSCollectionElementKindDayColumnHeader) {
//        MSDayColumnHeader *dayColumnHeader = [collectionView dequeueReusableSupplementaryViewOfKind:kind withReuseIdentifier:MSDayColumnHeaderReuseIdentifier forIndexPath:indexPath];
//
//        dayColumnHeader.titleBackgroundColor = (self.isDarkTheme) ? ApplicationThemeDarkCurrentTimeIndicator : ApplicationThemeLightCurrentTimeIndicator;
//        dayColumnHeader.titleTextColor = (self.isDarkTheme) ? ApplicationThemeDarkFontPrimaryColor : ApplicationThemeLightFontPrimaryColor;
//        dayColumnHeader.formatter = self.formatter;
//        dayColumnHeader.day = [self.collectionViewCalendarLayout dateForDayColumnHeaderAtIndexPath:indexPath];
//        dayColumnHeader.currentDay = YES;
//        dayColumnHeader.itemTitle = self.selectedItem[@"title"];
//
//        return dayColumnHeader;
//
//    } else if (kind == MSCollectionElementKindTimeRowHeader) {
//        MSTimeRowHeader *timeRowHeader = [collectionView dequeueReusableSupplementaryViewOfKind:kind withReuseIdentifier:MSTimeRowHeaderReuseIdentifier forIndexPath:indexPath];
//        timeRowHeader.textColor = (self.isDarkTheme) ? ApplicationThemeDarkFontPrimaryColor : ApplicationThemeLightFontPrimaryColor;
//        timeRowHeader.time = [self.collectionViewCalendarLayout dateForTimeRowHeaderAtIndexPath:indexPath];
//        return timeRowHeader;
//    }
//    return [[UICollectionReusableView alloc]init];
//}
//
//#pragma mark - UICollectionViewDelegate
//
//- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath {
//    [collectionView deselectItemAtIndexPath:indexPath animated:YES];
//}
//
//#pragma mark - Events
//
//- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
//    NSURL *pjURL = [NSURL URLWithString:@"hostingapp://home"];
//    [self.extensionContext openURL:pjURL completionHandler:nil];
//}
//
//#pragma mark - MSCollectionViewDelegateCalendarLayout
//
//- (NSArray <NSDate *>*)timeListForCollectionView:(UICollectionView *)collectionView layout:(MSCollectionViewCalendarLayout *)collectionViewLayout {
//    return self.pairDates;
//}
//
//- (NSDate *)currentTimeComponentsForCollectionView:(UICollectionView *)collectionView layout:(MSCollectionViewCalendarLayout *)collectionViewCalendarLayout {
//    return [NSDate date];
//}
//
//- (NSDate *)collectionView:(UICollectionView *)collectionView layout:(MSCollectionViewCalendarLayout *)collectionViewCalendarLayout startTimeForItemAtIndexPath:(NSIndexPath *)indexPath {
//    Lesson *lesson = [self.fetchedResultsController objectAtIndexPath:indexPath];
//    return lesson.start_time;
//}
//
//- (NSDate *)collectionView:(UICollectionView *)collectionView layout:(MSCollectionViewCalendarLayout *)collectionViewCalendarLayout endTimeForItemAtIndexPath:(NSIndexPath *)indexPath {
//    Lesson *lesson = [self.fetchedResultsController objectAtIndexPath:indexPath];
//    return lesson.end_time;
//}
//
//- (NSDate *)collectionView:(UICollectionView *)collectionView layout:(MSCollectionViewCalendarLayout *)collectionViewCalendarLayout dayForSection:(NSInteger)section {
//    id <NSFetchedResultsSectionInfo> sectionInfo = [self.fetchedResultsController.sections objectAtIndex:section];
//    Lesson *lesson = [sectionInfo.objects firstObject];
//    return lesson.day;
//}
//
//#pragma mark - DZNEmptyDataSetSource
//
//- (NSAttributedString *)titleForEmptyDataSet:(UIScrollView *)scrollView {
//    NSString *text = NSLocalizedString(@"TimeTable_NoItems", nil);
//
//    NSDictionary *attributes = @{NSFontAttributeName: [UIFont boldSystemFontOfSize:18.0f],
//                                 NSForegroundColorAttributeName: (self.isDarkTheme) ? [UIColor whiteColor] : [UIColor darkGrayColor]};
//
//    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
//}
//
//- (NSAttributedString *)descriptionForEmptyDataSet:(UIScrollView *)scrollView {
//    NSString *text = NSLocalizedString(@"TimeTable_NoItemsMessage", nil);
//
//    NSMutableParagraphStyle *paragraph = [NSMutableParagraphStyle new];
//    paragraph.lineBreakMode = NSLineBreakByWordWrapping;
//    paragraph.alignment = NSTextAlignmentCenter;
//
//    NSDictionary *attributes = @{NSFontAttributeName: [UIFont systemFontOfSize:14.0f],
//                                 NSForegroundColorAttributeName: (self.isDarkTheme) ? [UIColor whiteColor] : [UIColor darkGrayColor],
//                                 NSParagraphStyleAttributeName: paragraph};
//
//    return [[NSAttributedString alloc] initWithString:text attributes:attributes];
//}
//
//@end
